# Cấu hình cảnh báo Nagios qua Gmail

# Mục lục:
- [1. Tính năng gửi cảnh báo qua email](#1)
- [2. Topology lab & IP Planning](#2)
	- [2.1. Topology lab](#21)
	- [2.2. IP Planning](#22)
- [3. Các bước cấu hình để chuẩn bị gửi cảnh báo qua email](#3)
	- [3.1. Cấu hình gửi cảnh báo qua gmail](#31)
	- [3.2. Kiểm tra gửi email thử](#32)
- [4. Gửi cảnh báo khi có sự cố](#4)
	- [4.1. Gửi cảnh báo khi dịch vụ ssh down](#41)
	- [4.2. Gửi cảnh báo khi dịch vụ http down](#42)
	- [4.3. Gửi cảnh báo khi máy chủ off hoặc restart](#43)
- [5. Khác](#5)
- [6. Tài liệu tham khảo](#6)
	

----------------------------------------------


<a name="1"></a>
## 1. Tính năng gửi cảnh báo qua email
Trong thực tế, người quản trị viên không phải lúc nào cũng có thể ngồi theo dõi và nắm bắt các hoạt động của hệ thống qua giao diện giám sát. Bởi vậy bất cứ hệ thống giám sát nào cũng cần cung cấp các chức năng thông báo về tình trạng của hệ thống qua các phương tiện truyền thông. Nagios cũng cấp tính năng thông báo các sự kiện xảy ra qua phương tiện truyền thông là email. Bài viết này sẽ cung cấp cách gửi mail cảnh báo qua Gmail


<a name="2"></a>
## 2. Topology lab & IP Planning

<b>Lưu ý:</b> Để thực hành bài lab gửi email cảnh báo này, bạn bắt buộc phải thực hiện xong cài đặt Nagios Core trên Nagios Server và các dịch vụ ssh, http trên Client theo mô hình ở bài lab này trên CentOS7 <link>

Đối với bài lab này cần ít nhất là 02 máy chủ: Nagios Server và Web

<a name="21"></a>
### 2.1. Topology lab

<img src="">

<a name="22"></a>
### 2.2. IP Planning

| Hostname | OS | IP | Dịch vụ |
|----------|----|----|---------|
| Nagios Server | Centos 7 | 192.168.100.125 | Nagios Core |
| Web (client) | Ubuntu 14 | 192.168.100.150 | HTTP, SSH |


<a name="3"></a>
## 3. Các bước cấu hình để chuẩn bị gửi cảnh báo qua email

Trong bài viết này tôi sẽ hướng dẫn cấu hình gửi cảnh báo qua Gmail

<a name="31"></a>
### 3.1. Cấu hình gửi cảnh báo qua Gmail:

#### Các bước sau đây được thực hiện trên Nagios Server

- Bước 1: Cài đặt gói mail postfix

```sh
yum -y install postfix cyrus-sasl-plain mailx
```

- Bước 2: Cấu hình dịch vụ mail postfix

```sh
relayhost = [smtp.gmail.com]:587
smtp_use_tls = yes
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous
```

- Bước 3: Khởi động lại dich vụ

```sh
systemctl restart postfix
systemctl enable postfix
```

- Bước 4: Tạo 1 file để khai báo các thông số tài khoản mail xác thực

```sh
vi /etc/postfix/sasl_passwd

[smtp.gmail.com]:587 username:password
```

- Bước 5: Thiết lập chế độ less secure của Gmail

Trong 1 số trường hợp cần phải tắt chế độ hạn chế truy cập từ các ứng dụng không an toàn cho tài khoản gmail của bạn. Tham khảo link sau:

https://myaccount.google.com/lesssecureapps


<a name="32"></a>
### 3.2. Kiểm tra gửi email thử

- Bước 1: Thực hiện câu lệnh sau trên Nagios Server

```sh
echo "This is a test." | mail -s "test message" maiquoctri2102@gmail.com
```

- Bước 2: Kiểm tra trên hòm thư của Gmail
Nếu nhận được email như sau thì các bước cấu hình dịch vụ mail đã thành công

<img src="">

<a name="4"></a>
## 4. Gửi cảnh báo khi có sự cố
Đầu tiên phải thực hiện tạo thông tin liên lạc để Nagios biết được là phải gửi cảnh báo tới đâu khi hệ thống gặp vấn đề

#### Thực hiện các bước sau trên Nagios Server

- Bước 1: Thêm các thông tin liên lạc của Nagios
Ta sẽ tạo các thông tin liên lạc trong file `/usr/local/nagios/etc/objects/contacts.cfg`

```sh
vi /usr/local/nagios/etc/objects/contacts.cfg


define contact{
        contact_name                    nagiosadmin             ; Short name of user
        use                             generic-contact         ; Inherit default values from generic-contact template (defined above)
        alias                           Nagios Admin            ; Full name of user

        email                           trimq212@gmail.com        ; <<***** CHANGE THIS TO YOUR EMAIL ADDRESS ******

        service_notification_period             24x7
        service_notification_options            w,u,c,r,f,s
        service_notification_commands           notify-service-by-email
        host_notification_period                24x7
        host_notification_options               d,u,r,f,s
        host_notification_commands              notify-host-by-email
        }
```

#### Ý nghĩa của các tham số khai báo trên

<ul>
<li>service_notification_options: trạng thái sẽ gửi cảnh báo của service</li>
<li>w: warning</li>
<li>u: unknown service</li>
<li>c: critical</li>
<li>r: recovery service (trạng thái OK)</li>
<li>f: cảnh báo khi service khởi động và tắt FLAPPING</li>
<li>s: gửi cảnh báo khi dịch vụ downtime trong lịch trình</li>
<li>host_notification_options: trạng thái sẽ gửi cảnh báo của host</li>
<li>d: DOWN, cảnh báo khi host rơi vào trạng thái down</li>
</ul>

- Bước 2: Khởi động lại dịch vụ

```sh
/etc/init.d/nagios restart
```

Những bước cấu hình ở trên là để Nagios có thể tự động gửi mail khi hệ thống gặp sự cố. Trong trường hợp dịch vụ hoặc host được giám sát của tôi bị down thì Nagios phải gửi được email cho tôi để khắc phục sự cố.

Để kiểm chứng cho việc này, tôi sẽ thử kiểm tra bằng cách ngắt dịch vụ (ssh, http) và shutdown host đang giám sát. Lưu ý là trên client tôi đã giám sát được dịch vụ ssh và http như đã nói ở đầu bài viết

<a name="41"></a>
### 4.1. Gửi cảnh báo khi dịch vụ ssh down
Như đã nói ở trên, sau đây tôi sẽ thử lab email cảnh báo với dịch vụ ssh.

- Bước 1: Trên máy Client, thực hiện dừng dịch vụ ssh trên Client

```sh
service ssh stop
```

- Bước 2: Kiểm tra dịch vụ trên dashboard Nagios
Sau khi thực hiện ngừng dịch vụ ssh trên máy client, quay lại dashboard của Nagios để kiểm tra nếu trên dashboard thông báo như sau nghĩa là dịch vụ đã bị dừng

<img src="">

- Bước 3: Kiểm tra hòm thư Gmail 
Kiểm tra hòm thư Gmail để xem Nagios có tự động gửi mail cảnh báo đến không. Ở đây tôi đã nhận được mail cảnh báo đến

<img src="">

- Bước 4: Khởi động lại dịch vụ trên Client
Sau khi nhận được email cảnh báo, tôi sẽ khởi động lại dịch vụ để thử xem Nagios có gửi email bản tin Recovery

```sh
service ssh start
```

-Bước 5: Kiểm tra hoạt động của dịch vụ trên dashboard

Sau khi thực hiện khởi động dịch vụ, kiểm tra trên dashboard

<img src="">

- Bước 6: Kiểm tra email Recovey

Sau khi dịch vụ đã hoạt động trở lại, Nagios sẽ thông báo 1 bản tin cho người quản trị trạng thái của dịch vụ đó. Kiểm tra hòm thư để xác nhận

<img src="">

Như vậy là Nagios đã có thể gửi email cảnh báo khi dịch vụ bị down. Để kiểm chứng thêm tôi sẽ lab với dịch vụ khác là web

<a name="42"></a>
### 4.2. Gửi cảnh báo khi dịch vụ http down

Tương tự như dịch vụ ssh, tôi sẽ ngắt hoạt động của dịch vụ sau đó các bước làm sẽ giống như dịch vụ ssh

- Bước 1: Tương tự ssh, trên client tôi sẽ ngắt hoạt động dịch vụ web

```sh
service apache2 stop
```

- Bước 2: Kiểm tra trên dashboard của Nagios

<img src="http://i.imgur.com/OuaOAcM.png">

- Bước 3: Kiểm tra hòm thư Gmail

<img src="http://i.imgur.com/Yz88LeW.png">

- Bước 4: Khởi động lại dịch vụ

```sh
service apache2 start
```

- Bước 5: Kiểm tra trên dashboard 

<img src="http://i.imgur.com/G3aYXWJ.png">

- Bước 6: Kiểm tra hòm thư Gmail

<img src="http://i.imgur.com/1LQJtgD.png">





















<a name="5">
## 5. Khác


<a name="6"></a>
## 6. Tài liệu tham khảo

- https://access.redhat.com/documentation/en-US/Red_Hat_Storage/3/html/Console_Administration_Guide/Configuring_Nagios_to_Send_Mail_Notifications.html












