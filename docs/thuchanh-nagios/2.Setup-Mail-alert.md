# Cấu hình cảnh báo Nagios qua Gmail

# Mục lục:
- [1. Tính năng gửi cảnh báo qua email](#1)
- [2. Cấu hình cánh báo qua Gmail](#2)
- [3. Gửi cảnh báo khi có sự cố](#3)
	- [3.1 Gửi cảnh báo khi dịch vụ down](#31)
	- [3.2 Gửi cảnh báo theo ngưỡng](#32)
- [4. Tài liệu tham khảo](#4)

----------------------------------------------

Đây là hướng dẫn gửi mail cảnh báo qua Gmail, tham khảo cách gửi mail qua Email Domain tại [đây]()

<a name="1"></a>
## 1. Tính năng gửi cảnh báo qua email
Trong thực tế, người quản trị viên không phải lúc nào cũng có thể ngồi theo dõi và nắm bắt các hoạt động của hệ thống qua giao diện giám sát. Bởi vậy bất cứ hệ thống giám sát nào cũng cần cung cấp các chức năng thông báo về tình trạng của hệ thống qua các phương tiện truyền thông. Nagios cũng cấp tính năng thông báo các sự kiện xảy ra qua phương tiện truyền thông là email. Bài viết này sẽ cung cấp cách gửi mail cảnh báo qua Gmail


<a name="2"></a>
## 2. Cấu hình cánh báo qua Gmail

### Thực hiện các bước sau trên Nagios Server

#### Bước 1: Cài đặt Nagios Core 
Đầu tiên chúng ta phải cài đặt thành công hệ thống Nagios Core trước khi cấu hình gửi mail cảnh báo. 

Tham khảo cài đặt Nagios Core tại [đây](https://github.com/meditechopen/meditech-ghichep-nagios/blob/master/docs/thuchanh-nagios/1.Setup-CentOS-7.md)


#### Bước 2: Cấu hình email cảnh báo qua Gmail:

- Cài đặt gói mail Postfix
```sh
yum -y install postfix cyrus-sasl-plain mailx
```

- Khởi động lại dịch vụ
```sh
systemctl restart postfix
systemctl enable postfix
```

- Chỉnh sửa file cấu hình `/etc/postfix/main.cf`
```sh
relayhost = [smtp.gmail.com]:587
smtp_use_tls = yes
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous
```

- Tạo 1 file `/etc/postfix/sasl_passwd` để khai báo các thông số tài khoản mail xác thực
```sh
vi /etc/postfix/sasl_passwd

[smtp.gmail.com]:587 username:password
```

#### Bước 3: Gửi email để test thử
 
- Gửi mail test 
```sh
echo "This is a test." | mail -s "test message" trimq212@gmail.com
```

<img src="http://i.imgur.com/tponCE8.png">


<a name="3"></a>
## 3. Gửi cảnh báo khi có sự cố

### Thực hiện các bước sau trên Nagios server

#### Bước 1: Tạo thông tin liên lạc để gửi cảnh báo

- Thêm các thông tin để liên lạc trong file `/usr/local/nagios/etc/objects/contacts.cfg`
```sh
vi /usr/local/nagios/etc/objects/contacts.cfg


define contact{
        contact_name                    nagiosadmin             ; Short name of user
        use                             generic-contact         ; Inherit default values from generic-contact template (defined above)
        alias                           Nagios Admin            ; Full name of user

        email                           trimq212@gmail.com        ; <<***** CHANGE THIS TO YOUR EMAIL ADDRESS ******

        service_notification_period             24x7
        service_notification_options            w,u,c,r,f,s
        service_notification_commands           notify-service-by-email
        host_notification_period                24x7
        host_notification_options               d,u,r,f,s
        host_notification_commands              notify-host-by-email
        }
```


#### Giải thích các thông số cấu hình:

- <b>service_notification_options</b>: trạng thái sẽ gửi cảnh báo của service
<ul>
<li>w: warning</li>
<li>u: unknown service</li>
<li>c: critical</li>
<li>r: recovery service (trạng thái OK)</li>
<li>f: cảnh báo khi service khởi động và tắt FLAPPING</li>
<li>s: gửi cảnh báo khi dịch vụ downtime trong lịch trình</li>
</ul>
	
- <b>host_notification_options</b>: trạng thái sẽ gửi cảnh báo của host 
<ul>
<li>d: DOWN, cảnh báo khi host rơi vào trạng thái down</li>
</ul>

#### Bước 2: Khởi động lại dịch vụ

- Khởi động lại dịch vụ
```sh
/etc/init.d/nagios restart
```



<a name="31"></a>
### 3.1 Gửi cảnh báo khi dịch vụ down

### Thực hiện các bước sau trên client

#### Bước 1: Ngắt dịch vụ đang chạy trên client

- Trên máy client, stop dịch vụ ssh

```sh
service ssh stop
```

#### Bước 2: Xem thông tin về dịch vụ trên dashboard và kiểm tra email cảnh báo
- Thông tin trên dashboard

<img src="http://i.imgur.com/PiZI9vC.png">

- Email cảnh báo

<img src="http://i.imgur.com/fOF5odG.png">

#### Bước 3: Khởi động lại dịch vụ trên client

```sh
service ssh start
```

- Khi khởi động lại dịch vụ ssh. Bản tin recovery báo trạng thái OK

<img src="http://i.imgur.com/lulFsEU.png">


<a name="32"></a>
### 3.2 Gửi cảnh báo theo ngưỡng
Cơ chế cảnh báo theo ngưỡng được đặt ra, khi dịch vụ cần giám sát vượt quá ngưỡng cho phép thì Nagios Core sẽ gửi cảnh báo đến người quản trị. Sử dụng cơ chế giám sát NRPE để thực hiện. Tham khảo cài đặt NRPE tại [đây](https://github.com/meditechopen/meditech-ghichep-nagios/blob/master/docs/thuchanh-nagios/3.Setup-NagiosNRPE.md)

### Thực hiện các bước sau trên client

#### Bước 1: Thực hiện trên client

- Chỉnh sửa file cấu hình Nagios trên client như sau:
```sh
vi /etc/nagios/nrpe.cfg
```

- Khai báo như sau
```sh
command[check_cpu]=/usr/lib/nagios/plugins/check_cpu.sh -w 70 -c 80
```

Trong đó:
<ul>
<li><b>command[check_cpu]</b>: khai báo tên của command để trên Nagios server có thể giao tiếp được với plugin trên client</li>
<li><b>/usr/lib/nagios/plugins/check_cpu.sh</b>: đường dẫn để thực thi plugin</li>
<li><b>-w 70 -c 80</b>: là ngưỡng cảnh báo đặt ra, ở đây trạng thái warning là trên 70% và trạng thái critical là trên 80%</li>


#### Bước 2: Test thử ngưỡng trên client
- Thử kiểm tra ngưỡng với công cụ `iperf` trên client cần giám sát
```sh
iperf -s
```

#### Bước 3: Trên các máy server khác 
- Trên các máy khác đẩy dữ liệu về để CPU của client cần giám sát hoạt động quá ngưỡng. Sử dụng `iperf`. Nên sử dụng từ 3 đến 4 server để đẩy về host client đang giám sát 
```sh
iperf - t 300 -c <IP_client>
```

#### Bước 3: Kiểm chứng kết quả
- Kết quả là CPU của máy client đang chạy vượt ngưỡng cho phép và gửi đi mail cảnh báo như sau:

<img src="http://i.imgur.com/uRNJEJ9.png">

- Sau khi ngừng thực hiện `iperf` client sẽ trở về trạng thái ổn định và gửi mail thông báo

<img src="http://i.imgur.com/0I3coMG.png">



<a name="4"></a>
## 4. Tài liệu tham khảo

- https://access.redhat.com/documentation/en-US/Red_Hat_Storage/3/html/Console_Administration_Guide/Configuring_Nagios_to_Send_Mail_Notifications.html












